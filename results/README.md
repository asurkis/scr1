# Лабораторная работа Lab3 SCR1 RTL
## Цель
Исследование микроархитектуры и расширение функционала процессора SCR1

## Задание
| Вариант | Инструкция | Описание |
| --- | --- | --- | --- | --- | --- |
| 15 | Concatenation with immediate (`CNCI`) | `CNCI`: Конкатенация старших 20-bit регистра `RS1` и младших 12-bit константы, результат поместить в `RD` |

В вашем репозитории SCR1 от главной ветки master создать новую ветку с именем lab_rtl. В этой ветке вы можете коммитить все изменения проекта для данной лабораторной.

Убедитесь, что проект собирается и все тесты проходят в симуляции до внесения изменений в проект. Также убедитесь, что вы можете посмотреть вейвформы симуляции. Если вы используете Verilator в качестве симулятора, то для данной лабораторной вам нужно будет запускать его в режиме с генерацией вейвформ (`run_verilator_wf`).

Создайте в директории `./results` файл `README.md` с отчетом по проделанной работе. В отчете обязательно указать свой вариант задания.

### Добавление кастомной инструкции

1. Добавить в исходный код ядра новую кастомную инструкцию в соответствии с вариантом задания.
1. Способ машинного кодирования новой инструкции (расположение полей и значения opcode, funct и пр.) необходимо выбрать самостоятельно из области незарезервированных в RISC-V ISA опкодов. В отчете объяснить ваш выбор кодирования инструкции.
1. Поясните в виде блок-схемы или словесного описания в отчете какие изменения вы внести, в какие блоки и почему именно так.

Верификация

1. Написать ассемблерный тест для проверки новой инструкции. Так как компилятор ничего не знает о вашей кастомной инструкции, вместо мнемонического представления следует задавать ее как

        .word <инструкция в машинном коде> // комментарий с расшифровкой или мнемоникой

1. Тест должен покрывать несколько типичных случаев, в которых возможна ошибка. Поясните в отчете каждый выбранный вами типичный случай, на сколько хорошее тестовое покрытие будет обеспечено этим тестом.
1. Для отладки вы можете пользоваться Waveform (просмотр уровней внутренних сигналов rtl схемы), Dump, Tracelog. Приложите эти файлы в директорию ./results. Выведите на Waveform основные сигналы, которые показывают правильность прохождения инструкции по конвейеру - поясните в отчете ваш выбор.

## Выполнение
1. Запустил `make clean; make`, чтобы убедиться, что успешно проходят все тесты.
1. Создал файл `dependencies/riscv-tests/MyTest.S`:

        #include "riscv_test.h"

        RVTEST_RV32U

        RVTEST_CODE_BEGIN
                la      t0, testdata
                lw      t1, 0(t0)
                addi    t1, t1, 1
                la t0, result
                sw      t1, 0(t0)
                li      t3, 43
                bne     t1, t3, fail
                RVTEST_PASS
        fail:
                RVTEST_FAIL
        RVTEST_CODE_END

        .data
                .align 3
        testdata:
                .dword 41

        RVTEST_DATA_BEGIN
                .align 3
            result:
                .dword -1
        RVTEST_DATA_END

1. Добавил строку 68: `rv32_isa_tests = MyTest.S` к `sim/tests/riscv_isa/rv32_tests.inc`.
1. Запустил `make clean; make TARGETS=riscv_isa TRACE=1`, чтобы убедиться, что успешно проходит
    тест `MyTest`.
1. Заменил `li x3, 42` на `li x3, 43` в `MyTest.S` и убедился, что тест не проходит.
    В дальнейшем этот тест будет заменен на тест синтезируемой команды.
