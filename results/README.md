# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ Lab2 SCR1 sim
## –ó–∞–¥–∞–Ω–∏–µ
| –í–∞—Ä–∏–∞–Ω—Ç | –í–∏–¥ –∏—Å–∫–ª—é—á–µ–Ω–∏—è | –¢–µ—Å—Ç | Reset Vector | Trap Vector | –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ |
| ------- | -------------- | ---- | ------------ | ----------- | ------------- |
| 15 | Environment call from M-mode | `isa/rv32mi/scall.S` | `0xe00` | `0x840` | –í—ã–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏ `ecall` |


1. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ø–∏—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è SCR1 https://github.com/syntacore/scr1 –≤ –≤–∞—à –ª–∏—á–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ GitHub (–∫–æ—Ç–æ—Ä—ã–π –≤—ã –∑–∞–≤–æ–¥–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö). –≠—Ç–æ –±—É–¥–µ—Ç –≤–∞—à —Ä–∞–±–æ—á–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, –≤ –∫–æ—Ç–æ—Ä–æ–º –≤—ã —Å–º–æ–∂–µ—Ç–µ –¥–µ–ª–∞—Ç—å –ª—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –ø—Ä–æ–µ–∫—Ç–æ–º. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π fork https://help.github.com/en/articles/fork-a-repo.
1. –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É —Å –∏–º–µ–Ω–µ–º lab_sim. –í —ç—Ç–æ–π –≤–µ—Ç–∫–µ –≤—ã –±—É–¥–µ—Ç–µ –∫–æ–º–º–∏—Ç–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –¥–∞–Ω–Ω–æ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π.
    - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –≤ —Å–∏–º—É–ª—è—Ü–∏–∏ –¥–æ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø—Ä–æ–µ–∫—Ç. –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–±–æ—Ä–∫–µ –æ–ø–∏—Å–∞–Ω–∞ –≤ SCR1 User Manual —Ä–∞–∑–¥–µ–ª "Simulation enviroment".
    - –í –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã-—Å–∏–º—É–ª—è—Ç–æ—Ä–∞ –º—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Verilator, –Ω–æ –ø–æ –∂–µ–ª–∞–Ω–∏—é –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—É—é –∏–∑ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–≥–æ —Å–ø–∏—Å–∫–∞.

1. –í–∫–ª—é—á–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `TRACE`, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–∏–º—É–ª—è—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª—Å—è —Ç—Ä–µ–π—Å–ª–æ–≥. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤, —á—Ç–æ–±—ã –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω riscv_isa —Ç–µ—Å—Ç –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç—É –∑–∞–¥–∞–Ω–∏—è. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é –¥–ª—è Verilator –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —É—Å–ø–µ—à–Ω–æ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç –∏ —Ç—Ä–µ–π—Å–ª–æ–≥ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `build`.
1. –í —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤–∞—Ä–∏–∞–Ω—Ç–æ–º –∑–∞–¥–∞–Ω–∏—è –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏—Å–∫–ª—é—á–µ–Ω–∏–π `trap_vector` –≤ —Ñ–∞–π–ª–µ `./sim/tests/common/riscv_macros.h`.
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ —Ñ–∞–π–ª–µ `./src/includes/scr1_arch_description.svh` –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —è–¥—Ä–∞ Reset Vector –∏ Trap Vector –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤–∞—Ä–∏–∞–Ω—Ç–æ–º –∑–∞–¥–∞–Ω–∏—è.
1. –ò–∑–º–µ–Ω–∏—Ç—å linker-—Å–∫—Ä–∏–ø—Ç `./sim/tests/common/link.ld` –∏ —É—á–∞—Å—Ç–≤—É—é—â–∏–µ –≤ —Å–±–æ—Ä–∫–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞ —Å –Ω–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ Reset Vector –∏ Trap Vector.
1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `./results`: —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–º—É–ª—è—Ü–∏–∏ (`test_results.txt`), –¥–∏–∑–∞—Å—Å–µ–º–±–ª–µ—Ä —Ç–µ—Å—Ç–∞ (`*.dump`) –∏ —Ç—Ä–µ–π—Å –ª–æ–≥ (`tracelog_core_0.log`).
1. –°–æ–∑–¥–∞—Ç—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `./results` —Ñ–∞–π–ª —Å –æ—Ç—á–µ—Ç–æ–º –ø–æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π README.md.
1. –ó–∞–ø—É—à–∏—Ç—å –≤—Å–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–µ—Ç–∫—É `lab_sim`.

## –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
1. –ó–∞–ø—É—Å—Ç–∏–ª `make clean; make`, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç –≤—Å–µ —Ç–µ—Å—Ç—ã.
1. –î–æ–±–∞–≤–∏–ª —Å—Ç—Ä–æ–∫—É 68: `rv32_isa_tests = isa/rv32mi/scall.S` –∫ `sim/tests/riscv_isa/rv32_tests.inc`.
1. –ó–∞–ø—É—Å—Ç–∏–ª `make clean; make TARGETS=riscv_isa TRACE=1`, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–æ–≥–æ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–π —Ç–µ—Å—Ç –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞.
1. –î–æ–±–∞–≤–∏–ª –∫ —Ñ–∞–π–ª—É `sim/tests/common/riscv_macros.h` —Å—Ç—Ä–æ–∫–∏ 110-111:
    ```
    .org 0x740, 0; \
    .balign 64;    \
    ```
    –∏ 146:
    ```
    .org 0xD20, 0; \
    ```
    (–¥–∏—Ä–µ–∫—Ç–∏–≤–∞ `.org` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—á–∞–ª–∞ —Å–µ–∫—Ü–∏–∏, –∞ –Ω–µ –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∞–¥—Ä–µ—Å–∞—Ö,
    –ø–æ—ç—Ç–æ–º—É –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ—Å—å –∏—Å–∫–∞—Ç—å –ø–æ–¥–±–æ—Ä–æ–º)
1. –ü–æ–º–µ–Ω—è–ª —Å—Ç—Ä–æ–∫–∏ 141-142 –≤ —Ñ–∞–π–ª–µ `src/includes/scr1_arch_description.svh`:
    ```
    parameter bit [`SCR1_XLEN-1:0] SCR1_ARCH_RST_VECTOR = 'he00; // Reset vector value (start address after reset)
    parameter bit [`SCR1_XLEN-1:0] SCR1_ARCH_MTVEC_BASE = 'h840; // MTVEC.base field reset value, or constant value for MTVEC.base bits that are hardwired
    ```
    (–ø–æ–º–µ–Ω—è–ª –∑–Ω–∞—á–µ–Ω–∏—è —Å `'h200` –∏ `'h1c00` –Ω–∞ `'he00` –∏ `'h840` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ)
1. –ó–∞–ø—É—Å—Ç–∏–ª `make clean && make TARGETS=riscv_isa TRACE=1`, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∞–¥—Ä–µ—Å–∞ –º–µ—Ç–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ:
    1. –£–±–µ–¥–∏–ª—Å—è, —á—Ç–æ —Ç–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ:
        ```
        scall.hex		OK	  PASS
        ```
    1. –ü–æ—Å–º–æ—Ç—Ä–µ–ª –∞–¥—Ä–µ—Å–∞ `build/verilator_AHB_MAX_imc_IPIC_1_TCM_1_VIRQ_1_TRACE_1/scall.dump`:
        1. ```
            00000840 <trap_vector>:
            ```
        1. ```
            00000e00 <_start>:
            ```
    1. –ü–æ—Å–º–æ—Ç—Ä–µ–ª —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É `build/verilator_AHB_MAX_imc_IPIC_1_TCM_1_VIRQ_1_TRACE_1/tracelog_core_0.log`:
        1. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∞–¥—Ä–µ—Å–∞ `00000e00`
        1. –î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è (exception) –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ –∞–¥—Ä–µ—Å—É `00000840`
1. –î–æ–±–∞–≤–∏–ª —Å—Ç—Ä–æ–∫–∏ 209-212 –≤ —Ñ–∞–π–ª–µ ``:
    ```
    #define EXTRA_DATA                   \
      .section .data;                    \
      .balign 64;                        \
      variant_string: .string "ecall\n";
    ```
1. –î–æ–±–∞–≤–∏–ª –∫–æ–¥ –Ω–∞ —Å—Ç—Ä–æ–∫–∞—Ö 129-138 –≤ —Ñ–∞–π–ª–µ `sim/tests/common/riscv_macros.h`:
    ```
    _handle_machine_ecall:         \
            la t0, variant_string; \
            la t1, 0xF0000000;     \
            addi t2, x0, 0;        \
    1:      lb t2, 0(t0);          \
            beq t2, x0, 2f;        \
            sb t2, 0(t1);          \
            addi t0, t0, 1;        \
            j 1b;                  \
    2:      j _report;             \
    ```
1. –ü–æ–º–µ–Ω—è–ª —Å—Ç—Ä–æ–∫—É 120 –≤ —Ñ–∞–π–ª–µ `sim/tests/common/riscv_macros.h`:
    ```
            beq a4, a5, _handle_machine_ecall; \
    ```
1. –ó–∞–ø—É—Å—Ç–∏–ª `make clean && make TARGETS=riscv_isa TRACE=1`:
    1. –£–±–µ–¥–∏–ª—Å—è, —á—Ç–æ —Ç–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ:
        ```
        scall.hex		OK	  PASS
        ```
    1. –ü–æ—Å–º–æ—Ç—Ä–µ–ª –∞–¥—Ä–µ—Å–∞ `build/verilator_AHB_MAX_imc_IPIC_1_TCM_1_VIRQ_1_TRACE_1/scall.dump`:
        1. ```
            00000840 <trap_vector>:
            ```
        1. ```
            00000e00 <_start>:
            ```
        1. ```
            0000086c <_handle_machine_ecall>:
            ```
    1. –ü–æ—Å–º–æ—Ç—Ä–µ–ª —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É `build/verilator_AHB_MAX_imc_IPIC_1_TCM_1_VIRQ_1_TRACE_1/tracelog_core_0.log`:
        1. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∞–¥—Ä–µ—Å–∞ `00000e00`
        1. –î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è (exception) –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ –∞–¥—Ä–µ—Å—É `00000840`
        1. –í–æ –≤—Ä–µ–º—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ —Ü–∏–∫–ª—É `0000087c..0000088a` 5 —Ä–∞–∑, –Ω–∞ 6 &mdash; –≤—ã—Ö–æ–¥–∏—Ç
    1. –ü–æ—Å–º–æ—Ç—Ä–µ–ª –≤—ã–≤–æ–¥ —Ç–µ—Å—Ç–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:
        ```
        ---Test:                        scall.hex
        ecall
        Test passed
        ```
        –∏ –≤ —Ñ–∞–π–ª–µ `build/verilator_AHB_MAX_imc_IPIC_1_TCM_1_VIRQ_1_TRACE_1/sim_results.txt`:
        ```
        scr1_top_tb_ahb
        [0;34m---Test:                        scall.hex[0m
        ecall
        [0;32mTest passed[0m

        #--------------------------------------
        # Summary: 1/1 tests passed
        #--------------------------------------

        - /hdd/homework/comp-arch/scr1/src/tb/scr1_top_tb_runtests.sv:181: Verilog $finish
        ```
        —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—ã–≤–æ–¥–∏—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ &laquo;ecall&raquo;
1. –°–∫–æ–ø–∏—Ä–æ–≤–∞–ª —Ñ–∞–π–ª—ã `test_results.txt`, `scall.dump`, `tracelog_core_0.log` –∏ `sim_results.txt`
    –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `build/verilator_AHB_MAX_imc_IPIC_1_TCM_1_VIRQ_1_TRACE_1`
    –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `results`.
## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –ò–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∏–º—É–ª—è—Ü–∏–∏ `test_results.txt` –≤–∏–¥–Ω–æ, —á—Ç–æ –±—ã–ª –≤—ã–±—Ä–∞–Ω —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π —Ç–µ—Å—Ç –∏ —Ç–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è.
- –ò–∑ –¥–∞–º–ø–∞ —Ç–µ—Å—Ç–∞ `scall.dump` –≤–∏–¥–Ω–æ, —á—Ç–æ `trap_vector` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É `0x840`, –∞ `_start` –ø–æ –∞–¥—Ä–µ—Å—É `0xe00`.
- –ò–∑ —Ç—Ä–µ–π—Å–ª–æ–≥–∞ `tracelog_core_0.log` –≤–∏–¥–Ω–æ, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∞–¥—Ä–µ—Å–∞ `0xe00` –∏ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ `exception` –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –∞–¥—Ä–µ—Å—É `0x840`, –∞ —Ç–∞–∫–∂–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ —Ü–∏–∫–ª—É `0x87c..0x88a` –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏ &laquo;ecall&raquo;.
- –ò–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∏–º—É–ª—è—Ü–∏–∏ `sim_results.txt` –≤–∏–¥–Ω–æ, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ &laquo;ecall&raquo; –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª.
